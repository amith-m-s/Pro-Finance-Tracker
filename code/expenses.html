<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pro Finance Tracker</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom CSS for additional styling -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .modal-scale-in { animation: scaleIn 0.3s cubic-bezier(0.165, 0.84, 0.44, 1) forwards; }
        @keyframes scaleIn {
            0% { transform: scale(0.95); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        input[type=number] {
            appearance: textfield;
            -moz-appearance: textfield;
        }
        .transaction-type-btn.active {
            background-color: #4338ca; /* indigo-700 */
            color: white;
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 antialiased transition-colors duration-300">

    <!-- Main Application Container -->
    <div class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">

        <!-- Header -->
        <header class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <div>
                <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-slate-700 to-indigo-700 dark:from-slate-300 dark:to-indigo-400">Finance Tracker</h1>
                <p class="text-slate-500 dark:text-slate-400 mt-1">A smarter way to manage your money.</p>
            </div>
            <div class="flex items-center gap-2 mt-4 sm:mt-0">
                <button id="theme-toggle-btn" title="Toggle Theme" class="text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-800">
                    <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
                 <button id="reset-data-btn" title="Reset All Data" class="text-slate-500 dark:text-slate-400 hover:text-red-600 transition-colors p-2 rounded-lg hover:bg-red-100 dark:hover:bg-slate-800">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L20.5 10"></path><path d="M20.49 15a9 9 0 0 1-14.85 3.36L3.5 14"></path></svg>
                </button>
                <button id="add-transaction-btn" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-all duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Add Transaction
                </button>
            </div>
        </header>

        <!-- Main Content Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Left Column: Summary and Categories -->
            <div class="lg:col-span-1 space-y-8">
                <div class="bg-blue-100/60 dark:bg-blue-900/30 backdrop-blur-lg p-6 rounded-2xl shadow-lg border border-blue-200/50 dark:border-blue-800/50 transition-shadow hover:shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-blue-900 dark:text-blue-100">Account Balance</h2>
                    <p class="text-4xl font-bold text-slate-800 dark:text-slate-100">₹<span id="current-balance">0.00</span></p>
                    <hr class="my-4 border-blue-200/80 dark:border-blue-800/80">
                    <div class="flex justify-between text-sm">
                        <div><p class="text-slate-500 dark:text-slate-400">Total Income</p><p class="font-bold text-green-600 text-lg">₹<span id="total-income">0.00</span></p></div>
                        <div><p class="text-slate-500 dark:text-slate-400">Total Expenses</p><p class="font-bold text-red-500 text-lg">₹<span id="total-expenses">0.00</span></p></div>
                    </div>
                </div>

                <div class="bg-amber-100/60 dark:bg-amber-900/30 backdrop-blur-lg p-6 rounded-2xl shadow-lg border border-amber-200/50 dark:border-amber-800/50 transition-shadow hover:shadow-xl">
                     <h2 class="text-xl font-semibold mb-4 text-amber-900 dark:text-amber-100">Monthly Overview</h2>
                    <div class="flex justify-between items-center mb-4">
                        <span id="current-month-display" class="font-semibold text-slate-700 dark:text-slate-300">October 2025</span>
                        <div class="flex items-center gap-1 sm:gap-2">
                            <button id="prev-month-btn" title="Previous Month" class="p-1.5 rounded-md hover:bg-slate-100/50 dark:hover:bg-slate-800/50 transition-colors disabled:opacity-50"><svg class="w-5 h-5 text-slate-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></button>
                            <button id="next-month-btn" title="Next Month" class="p-1.5 rounded-md hover:bg-slate-100/50 dark:hover:bg-slate-800/50 transition-colors disabled:opacity-50"><svg class="w-5 h-5 text-slate-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></button>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-baseline mb-1"><span class="text-sm text-slate-500 dark:text-slate-400">Monthly Spending</span><span class="text-sm font-medium text-slate-500 dark:text-slate-400">Budget: ₹<span id="budget-display">0.00</span></span></div>
                        <h3 class="text-3xl font-bold text-red-500">₹<span id="monthly-spent">0.00</span></h3>
                    </div>
                    <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 mt-2"><div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div></div>
                    <button id="set-budget-btn" class="mt-4 w-full text-sm text-indigo-600 font-semibold py-2 px-4 rounded-lg border-2 border-indigo-200 hover:bg-indigo-100/50 dark:border-indigo-800 dark:text-indigo-300 dark:hover:bg-indigo-900/30 transition-colors">Set Budget</button>
                </div>

                <div class="bg-violet-100/60 dark:bg-violet-900/30 backdrop-blur-lg p-6 rounded-2xl shadow-lg border border-violet-200/50 dark:border-violet-800/50 transition-shadow hover:shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-violet-900 dark:text-violet-100">Monthly Expense Breakdown</h2>
                    <div class="h-64 flex items-center justify-center"><canvas id="category-chart"></canvas></div>
                </div>
            </div>

            <!-- Right Column: Transaction List -->
            <div class="lg:col-span-2 bg-slate-100/60 dark:bg-slate-800/30 backdrop-blur-lg p-6 rounded-2xl shadow-lg border border-slate-200/50 dark:border-slate-700/50 transition-shadow hover:shadow-xl">
                 <div class="flex justify-between items-center mb-4">
                     <h2 class="text-xl font-semibold">Transaction History</h2>
                     <button id="export-csv-btn" title="Export to CSV" class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-300 font-medium py-1.5 px-3 rounded-lg border-2 border-slate-200 dark:border-slate-600 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Export
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table id="transaction-table" class="w-full text-sm text-left text-slate-500 dark:text-slate-400">
                        <thead class="text-xs text-slate-700 dark:text-slate-300 uppercase bg-transparent"><tr><th scope="col" class="px-6 py-3">Date</th><th scope="col" class="px-6 py-3">Category</th><th scope="col" class="px-6 py-3">Amount</th><th scope="col" class="px-6 py-3 hidden md:table-cell">Note</th><th scope="col" class="px-6 py-3 text-right">Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                     <div id="empty-state" class="hidden text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-slate-400 dark:text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14h6M9 8h6m-6 12h6m-6-6h6M4 6h16M4 10h16M4 14h16M4 18h16a2 2 0 002-2V6a2 2 0 00-2-2H4a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <h3 class="mt-2 text-sm font-semibold text-slate-900 dark:text-slate-200">No transactions yet</h3>
                        <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Get started by adding a new transaction.</p>
                      </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="transaction-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-slate-50 dark:bg-slate-800 w-full max-w-md p-6 rounded-2xl shadow-xl modal-scale-in">
            <h2 id="modal-title" class="text-xl font-bold mb-6 dark:text-white">Add Transaction</h2>
            <form id="transaction-form">
                <input type="hidden" id="edit-id">
                <div class="mb-4"><div class="flex w-full bg-slate-200 dark:bg-slate-700 rounded-lg p-1"><button type="button" data-type="expense" class="transaction-type-btn w-1/2 py-2 text-sm font-semibold rounded-md transition-colors active">Expense</button><button type="button" data-type="income" class="transaction-type-btn w-1/2 py-2 text-sm font-semibold rounded-md transition-colors">Income</button></div></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label for="date" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Date</label><input type="date" id="date" required class="w-full px-3 py-2 border bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></div>
                    <div><label for="amount" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Amount (₹)</label><input type="number" id="amount" step="0.01" required placeholder="0.00" class="w-full px-3 py-2 border bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></div>
                </div>
                <div class="mt-4"><label for="category" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Category</label><select id="category" class="w-full px-3 py-2 border bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></select></div>
                <div class="mt-4"><label for="note" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Note (Optional)</label><input type="text" id="note" placeholder="e.g., Coffee with friends" class="w-full px-3 py-2 border bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></div>
                <div class="mt-6 flex justify-end gap-3"><button type="button" id="cancel-btn" class="bg-slate-200 text-slate-700 dark:bg-slate-600 dark:text-slate-200 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Cancel</button><button type="submit" id="save-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition">Save Transaction</button></div>
            </form>
        </div>
    </div>
    
    <div id="budget-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-slate-50 dark:bg-slate-800 w-full max-w-sm p-6 rounded-2xl shadow-xl modal-scale-in">
            <h2 id="budget-modal-title" class="text-xl font-bold mb-6 dark:text-white">Set Budget</h2>
            <form id="budget-form">
                <div><label for="budget-amount" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Budget Amount (₹)</label><input type="number" id="budget-amount" step="0.01" required placeholder="0.00" class="w-full px-3 py-2 border bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></div>
                <div class="mt-6 flex justify-end gap-3"><button type="button" id="cancel-budget-btn" class="bg-slate-200 text-slate-700 dark:bg-slate-600 dark:text-slate-200 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Cancel</button><button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition">Save Budget</button></div>
            </form>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // DOM Elements
            const htmlEl = document.documentElement;
            const themeToggleBtn = document.getElementById("theme-toggle-btn");
            const lightIcon = document.getElementById("theme-icon-light");
            const darkIcon = document.getElementById("theme-icon-dark");
            const exportCsvBtn = document.getElementById("export-csv-btn");
            const transactionTableBody = document.querySelector("#transaction-table tbody");
            const totalIncomeEl = document.getElementById("total-income");
            const totalExpensesEl = document.getElementById("total-expenses");
            const currentBalanceEl = document.getElementById("current-balance");
            const monthlySpentEl = document.getElementById("monthly-spent");
            const emptyStateEl = document.getElementById("empty-state");
            const budgetDisplayEl = document.getElementById("budget-display");
            const progressBarEl = document.getElementById("progress-bar");
            const resetDataBtn = document.getElementById("reset-data-btn");
            const monthDisplayEl = document.getElementById("current-month-display");
            const prevMonthBtn = document.getElementById("prev-month-btn");
            const nextMonthBtn = document.getElementById("next-month-btn");
            const transactionModal = document.getElementById("transaction-modal");
            const addTransactionBtn = document.getElementById("add-transaction-btn");
            const cancelBtn = document.getElementById("cancel-btn");
            const transactionForm = document.getElementById("transaction-form");
            const modalTitle = document.getElementById("modal-title");
            const saveBtn = document.getElementById("save-btn");
            const transactionTypeBtns = document.querySelectorAll(".transaction-type-btn");
            const dateInput = document.getElementById("date");
            const categoryInput = document.getElementById("category");
            const amountInput = document.getElementById("amount");
            const noteInput = document.getElementById("note");
            const editIdInput = document.getElementById("edit-id");
            const budgetModal = document.getElementById("budget-modal");
            const setBudgetBtn = document.getElementById("set-budget-btn");
            const budgetModalTitle = document.getElementById("budget-modal-title");
            const budgetForm = document.getElementById("budget-form");
            const budgetAmountInput = document.getElementById("budget-amount");
            const cancelBudgetBtn = document.getElementById("cancel-budget-btn");

            // Chart
            const ctx = document.getElementById('category-chart').getContext('2d');
            let categoryChart;

            // App State
            let appState = {
                transactions: JSON.parse(localStorage.getItem("transactions")) || [],
                budgets: JSON.parse(localStorage.getItem("budgets")) || {},
                selectedDate: new Date()
            };
            let currentTransactionType = 'expense';
            const expenseCategories = ['Food', 'Groceries', 'Transport', 'Rent', 'Utilities', 'Entertainment', 'Shopping', 'Health', 'Education', 'Travel', 'Other'];
            const incomeCategories = ['Salary', 'Bonus', 'Gift', 'Investment', 'Other'];
            
            // --- NEW: Theme Management ---
            const checkTheme = () => {
                const userTheme = localStorage.getItem("theme");
                const systemTheme = window.matchMedia("(prefers-color-scheme: dark)").matches;
                if (userTheme === "dark" || (!userTheme && systemTheme)) {
                    htmlEl.classList.add("dark");
                    lightIcon.classList.add("hidden");
                    darkIcon.classList.remove("hidden");
                } else {
                    htmlEl.classList.remove("dark");
                    lightIcon.classList.remove("hidden");
                    darkIcon.classList.add("hidden");
                }
                renderChart(); // Re-render chart for theme colors
            };

            themeToggleBtn.addEventListener("click", () => {
                if (htmlEl.classList.contains("dark")) {
                    htmlEl.classList.remove("dark");
                    localStorage.setItem("theme", "light");
                } else {
                    htmlEl.classList.add("dark");
                    localStorage.setItem("theme", "dark");
                }
                checkTheme();
            });

            // --- NEW: Export to CSV ---
            exportCsvBtn.addEventListener("click", () => {
                const transactions = appState.transactions;
                if (transactions.length === 0) {
                    alert("No transactions to export.");
                    return;
                }

                const headers = ["ID", "Type", "Date", "Category", "Amount", "Note"];
                const csvRows = [headers.join(",")];

                transactions.forEach(tx => {
                    const row = [
                        tx.id,
                        tx.type,
                        tx.date,
                        tx.category,
                        tx.amount,
                        `"${tx.note ? tx.note.replace(/"/g, '""') : ""}"` // Handle notes with commas/quotes
                    ];
                    csvRows.push(row.join(","));
                });

                const csvString = csvRows.join("\n");
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.setAttribute("href", url);
                const dateStr = new Date().toISOString().split('T')[0];
                a.setAttribute("download", `finance_tracker_export_${dateStr}.csv`);
                a.style.visibility = 'hidden';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
            
            // --- Modal & Form Handling ---
            const openModal = (modal) => modal.classList.remove("hidden");
            const closeModal = (modal) => modal.classList.add("hidden");

            addTransactionBtn.addEventListener("click", () => {
                modalTitle.textContent = "Add New Transaction";
                saveBtn.textContent = "Save Transaction";
                transactionForm.reset();
                editIdInput.value = "";
                dateInput.value = new Date().toISOString().split('T')[0];
                setTransactionType('expense');
                openModal(transactionModal);
            });
            cancelBtn.addEventListener("click", () => closeModal(transactionModal));

            const setTransactionType = (type) => {
                currentTransactionType = type;
                transactionTypeBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.type === type));
                const categories = type === 'expense' ? expenseCategories : incomeCategories;
                categoryInput.innerHTML = categories.map(c => `<option>${c}</option>`).join('');
            };
            transactionTypeBtns.forEach(btn => btn.addEventListener('click', () => setTransactionType(btn.dataset.type)));

            setBudgetBtn.addEventListener("click", () => {
                const monthYear = getMonthYearKey(appState.selectedDate);
                const currentBudget = appState.budgets[monthYear] || '';
                budgetAmountInput.value = currentBudget;
                budgetModalTitle.textContent = `Set Budget for ${formatMonth(appState.selectedDate)}`;
                openModal(budgetModal);
            });
            cancelBudgetBtn.addEventListener("click", () => closeModal(budgetModal));
            
            // --- Data & State Management ---
            const getMonthYearKey = (date) => `${date.getFullYear()}-${date.getMonth()}`;
            const formatMonth = (date) => date.toLocaleString('default', { month: 'long', year: 'numeric' });

            const saveData = () => {
                localStorage.setItem("transactions", JSON.stringify(appState.transactions));
                localStorage.setItem("budgets", JSON.stringify(appState.budgets));
            };
            
            const getMonthlyData = () => {
                const selectedMonth = appState.selectedDate.getMonth();
                const selectedYear = appState.selectedDate.getFullYear();
                const monthYearKey = getMonthYearKey(appState.selectedDate);
                const budgetForMonth = appState.budgets[monthYearKey] || 0;
                const monthlyExpenses = appState.transactions.filter(tx => {
                    const txDate = new Date(tx.date);
                    return tx.type === 'expense' && txDate.getMonth() === selectedMonth && txDate.getFullYear() === selectedYear;
                });
                const monthlyTotal = monthlyExpenses.reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
                const categoryMap = monthlyExpenses.reduce((acc, tx) => {
                    acc[tx.category] = (acc[tx.category] || 0) + parseFloat(tx.amount);
                    return acc;
                }, {});
                return { monthlyTotal, budgetForMonth, categoryMap, monthlyExpenses };
            }

            // --- Main Render Function ---
            const render = () => {
                renderDashboard();
                renderTransactions();
                renderChart();
                updateEmptyState();
                saveData();
            };
            
            // --- Rendering Sub-functions ---
            const renderTransactions = () => {
                transactionTableBody.innerHTML = "";
                const sortedTransactions = [...appState.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
                sortedTransactions.forEach((tx) => {
                    const isExpense = tx.type === 'expense';
                    const row = document.createElement("tr");
                    row.className = "border-b border-slate-200/50 dark:border-slate-700/50 hover:bg-slate-200/40 dark:hover:bg-slate-700/40";
                    row.innerHTML = `<td class="px-6 py-4">${new Date(tx.date).toLocaleDateString()}</td><td class="px-6 py-4 font-medium text-slate-900 dark:text-slate-100">${tx.category}</td><td class="px-6 py-4 font-semibold ${isExpense ? 'text-red-500' : 'text-green-600'}">${isExpense ? '−' : '+'}₹${parseFloat(tx.amount).toFixed(2)}</td><td class="px-6 py-4 hidden md:table-cell">${tx.note || ""}</td><td class="px-6 py-4 text-right"><button class="edit-btn font-medium text-indigo-600 hover:underline mr-3" data-id="${tx.id}">Edit</button><button class="delete-btn font-medium text-red-600 hover:underline" data-id="${tx.id}">Delete</button></td>`;
                    transactionTableBody.appendChild(row);
                });
            };
            const renderDashboard = () => {
                monthDisplayEl.textContent = formatMonth(appState.selectedDate);
                nextMonthBtn.disabled = appState.selectedDate.getMonth() === new Date().getMonth() && appState.selectedDate.getFullYear() === new Date().getFullYear();
                const totalIncome = appState.transactions.filter(tx => tx.type === 'income').reduce((sum, tx) => sum + parseFloat(tx.amount), 0);
                const totalExpenses = appState.transactions.filter(tx => tx.type === 'expense').reduce((sum, tx) => sum + parseFloat(tx.amount), 0);
                totalIncomeEl.textContent = totalIncome.toFixed(2);
                totalExpensesEl.textContent = totalExpenses.toFixed(2);
                currentBalanceEl.textContent = (totalIncome - totalExpenses).toFixed(2);
                const { monthlyTotal, budgetForMonth } = getMonthlyData();
                monthlySpentEl.textContent = monthlyTotal.toFixed(2);
                budgetDisplayEl.textContent = parseFloat(budgetForMonth).toFixed(2);
                const progress = budgetForMonth > 0 ? (monthlyTotal / budgetForMonth) * 100 : 0;
                progressBarEl.style.width = `${Math.min(progress, 100)}%`;
                progressBarEl.classList.toggle('bg-red-500', progress > 100);
                progressBarEl.classList.toggle('bg-indigo-600', progress <= 100);
            };
            const renderChart = () => {
                const { categoryMap } = getMonthlyData();
                const labels = Object.keys(categoryMap);
                const data = Object.values(categoryMap);
                const isDarkMode = htmlEl.classList.contains('dark');
                const legendColor = isDarkMode ? '#cbd5e1' : '#475569';
                
                if (categoryChart) categoryChart.destroy();
                if(labels.length > 0) {
                    categoryChart = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ data: data, backgroundColor: ['#ef4444', '#3b82f6', '#eab308', '#8b5cf6', '#14b8a6', '#ec4899', '#f97316'], hoverOffset: 4,  borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 15, boxWidth: 12, color: legendColor } } } } });
                } else {
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.save();
                    ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = isDarkMode ? '#64748b' : '#94a3b8'; ctx.font = '14px Inter';
                    ctx.fillText(`No expense data for ${formatMonth(appState.selectedDate)}.`, ctx.canvas.width / 2, ctx.canvas.height / 2);
                    ctx.restore();
                }
            };
            const updateEmptyState = () => {
                const showEmpty = appState.transactions.length === 0;
                emptyStateEl.classList.toggle('hidden', !showEmpty);
                transactionTableBody.parentElement.classList.toggle('hidden', showEmpty);
            };

            // --- Event Handlers ---
            transactionForm.addEventListener("submit", (e) => {
                e.preventDefault();
                const newTransaction = { id: editIdInput.value || Date.now(), type: currentTransactionType, date: dateInput.value, category: categoryInput.value, amount: amountInput.value, note: noteInput.value };
                if (editIdInput.value) {
                    appState.transactions[appState.transactions.findIndex(tx => tx.id == editIdInput.value)] = newTransaction;
                } else {
                    appState.transactions.push(newTransaction);
                }
                closeModal(transactionModal);
                render();
            });
            budgetForm.addEventListener("submit", (e) => {
                e.preventDefault();
                const monthYearKey = getMonthYearKey(appState.selectedDate);
                appState.budgets[monthYearKey] = parseFloat(budgetAmountInput.value) || 0;
                closeModal(budgetModal);
                render();
            });
            transactionTableBody.addEventListener("click", (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const id = target.dataset.id;
                if (target.classList.contains("delete-btn")) {
                    if (confirm("Are you sure you want to delete this transaction?")) {
                        appState.transactions = appState.transactions.filter(tx => tx.id != id);
                        render();
                    }
                }
                if (target.classList.contains("edit-btn")) {
                    const tx = appState.transactions.find(t => t.id == id);
                    modalTitle.textContent = "Edit Transaction";
                    saveBtn.textContent = "Update Transaction";
                    editIdInput.value = tx.id; dateInput.value = tx.date; amountInput.value = tx.amount; noteInput.value = tx.note;
                    setTransactionType(tx.type);
                    categoryInput.value = tx.category;
                    openModal(transactionModal);
                }
            });
            prevMonthBtn.addEventListener("click", () => {
                appState.selectedDate.setMonth(appState.selectedDate.getMonth() - 1);
                render();
            });
            nextMonthBtn.addEventListener("click", () => {
                appState.selectedDate.setMonth(appState.selectedDate.getMonth() + 1);
                render();
            });
            resetDataBtn.addEventListener("click", () => {
                if(confirm("Are you sure you want to delete ALL data? This action cannot be undone.")){
                    appState.transactions = []; appState.budgets = {}; localStorage.clear();
                    render();
                }
            });

            // Initial render on page load
            checkTheme();
            render();
        });
    </script>
</body>
</html>

